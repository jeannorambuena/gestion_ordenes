{% extends 'base.html' %}

{% block title %}Nueva Jefatura DAEM{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4">Asignar Nueva Jefatura DAEM</h2>

  <form method="POST" action="{{ url_for('jefatura_daem.nueva_jefatura_daem') }}"
        class="mx-auto p-4 shadow rounded bg-light"
        style="max-width: 600px;">
    {{ form.hidden_tag() }}

    <!-- Funcionario seleccionado desde modal -->
    <div class="mb-3">
      <label for="nombre_funcionario" class="form-label">Funcionario</label>
      <div class="input-group">
        {{ form.rut_funcionario(type="hidden", id="rut_funcionario") }}
        <input type="text"
               id="nombre_funcionario"
               class="form-control"
               placeholder="Haz clic aquí o en la lupa para buscar un funcionario"
               readonly required>
        <button type="button"
                id="buscar-funcionario-btn"
                class="btn btn-outline-primary"
                data-target-context="jefatura_daem"
                title="Buscar funcionario por RUT, nombre o apellido">
          <i class="fas fa-search"></i>
        </button>
      </div>
      {% for error in form.rut_funcionario.errors %}
        <div class="text-danger">{{ error }}</div>
      {% endfor %}
    </div>

    <!-- Cargo a asignar desde form.id_cargo -->
    <div class="mb-3">
      <label for="id_cargo" class="form-label">Cargo a Asignar</label>
      {{ form.id_cargo(class="form-select", id="id_cargo") }}
      {% for error in form.id_cargo.errors %}
        <div class="text-danger">{{ error }}</div>
      {% endfor %}
    </div>

    <!-- Fecha de Inicio -->
    <div class="mb-3">
      <label for="fecha_inicio" class="form-label">Fecha de Inicio</label>
      {{ form.fecha_inicio(class="form-control", id="fecha_inicio") }}
      {% for error in form.fecha_inicio.errors %}
        <div class="text-danger">{{ error }}</div>
      {% endfor %}
    </div>

    <!-- Fecha de Término -->
    <div class="mb-3">
      <label for="fecha_termino" class="form-label">Fecha de Término</label>
      {{ form.fecha_termino(class="form-control", id="fecha_termino") }}
      {% for error in form.fecha_termino.errors %}
        <div class="text-danger">{{ error }}</div>
      {% endfor %}
    </div>

    <!-- Botones -->
    <div class="d-flex justify-content-between">
      <button type="submit" class="btn btn-success">Guardar</button>
      <a href="{{ url_for('jefatura_daem.listar_jefaturas_daem') }}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
</div>

<!-- Modal reutilizable -->
{% include 'componentes/modal_busqueda_funcionario.html' %}

<!-- Scripts -->
<script>
  // ✅ Esta función debe estar en el scope global, NO dentro de DOMContentLoaded
  window.seleccionarFuncionarioParaJefaturaDaem = function (data) {
    const campoNombre = document.getElementById("nombre_funcionario");
    const campoRut = document.getElementById("rut_funcionario");

    if (campoNombre) campoNombre.value = `${data.nombre} ${data.apellido}`;
    if (campoRut) campoRut.value = data.rut;

    console.log("✅ Funcionario traspasado al formulario Jefatura DAEM");
  };

  document.addEventListener("DOMContentLoaded", function () {
    const boton = document.getElementById("buscar-funcionario-btn");

    if (boton) {
      boton.dataset.targetContext = "jefatura_daem";
      boton.addEventListener("click", function () {
        $('#modalBuscarFuncionario').modal('show');
      });
    }

    const campoFuncionario = document.getElementById("nombre_funcionario");
    if (campoFuncionario && boton) {
      campoFuncionario.addEventListener("click", function () {
        boton.click(); // Simula el click en el botón
      });
    }
  });
</script>

{% endblock %}
