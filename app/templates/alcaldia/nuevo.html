{% extends 'base.html' %}

{% block title %}Nueva Alcaldía{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4">Asignar Nueva Alcaldía</h2>

  <form method="POST" action="{{ url_for('alcaldia.nueva_alcaldia') }}"
        class="mx-auto p-4 shadow rounded bg-light"
        style="max-width: 600px;">
    {{ form.hidden_tag() }}

    <!-- Funcionario seleccionado desde modal -->
    <div class="mb-3">
      <label for="nombre_alcalde" class="form-label">Funcionario</label>
      <div class="input-group">
        {{ form.nombre_alcalde(class="form-control", id="nombre_alcalde", placeholder="Haz clic aquí o en la lupa para buscar un funcionario", readonly=true, required=true) }}
        {{ form.rut_alcalde(id="rut_alcalde", type="hidden") }}
        <button type="button"
                id="buscar-funcionario-btn"
                class="btn btn-outline-primary"
                data-target-context="alcaldia"
                title="Buscar funcionario por RUT, nombre o apellido">
          <i class="fas fa-search"></i>
        </button>
      </div>
      {% for error in form.nombre_alcalde.errors %}
        <div class="text-danger">{{ error }}</div>
      {% endfor %}
    </div>

    <!-- Cargo a asignar desde form.id_cargo -->
    <div class="mb-3">
      <label for="id_cargo" class="form-label">Cargo a Asignar</label>
      {{ form.id_cargo(class="form-select", id="id_cargo") }}
      {% for error in form.id_cargo.errors %}
        <div class="text-danger">{{ error }}</div>
      {% endfor %}
    </div>

    <!-- Fecha de Inicio -->
    <div class="mb-3">
      <label for="fecha_inicio" class="form-label">Fecha de Inicio</label>
      {{ form.fecha_inicio(class="form-control", id="fecha_inicio") }}
      {% for error in form.fecha_inicio.errors %}
        <div class="text-danger">{{ error }}</div>
      {% endfor %}
    </div>

    <!-- Fecha de Término -->
    <div class="mb-3">
      <label for="fecha_termino" class="form-label">Fecha de Término</label>
      {{ form.fecha_termino(class="form-control", id="fecha_termino") }}
      {% for error in form.fecha_termino.errors %}
        <div class="text-danger">{{ error }}</div>
      {% endfor %}
    </div>

    <!-- Botones -->
    <div class="d-flex justify-content-between">
      <button type="submit" class="btn btn-success">Guardar</button>
      <a href="{{ url_for('alcaldia.listar_alcaldias') }}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
</div>

<!-- Modal de búsqueda reutilizable -->
{% include 'componentes/modal_busqueda_funcionario.html' %}

<!-- Script para búsqueda -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const boton = document.getElementById("buscar-funcionario-btn");

  if (boton) {
    boton.dataset.targetContext = "alcaldia";
    boton.addEventListener("click", function () {
      $('#modalBuscarFuncionario').modal('show');
    });
  }

  const campoFuncionario = document.getElementById("nombre_alcalde");
  if (campoFuncionario && boton) {
    campoFuncionario.addEventListener("click", function () {
      boton.click(); // Simula el click en el botón
    });
  }

  // Función invocada desde scripts.js cuando se selecciona un funcionario
  window.seleccionarFuncionarioParaAlcaldia = function (data) {
    document.getElementById("nombre_alcalde").value = `${data.nombre} ${data.apellido}`;
    document.getElementById("rut_alcalde").value = data.rut;
  };
});
</script>
{% endblock %}
